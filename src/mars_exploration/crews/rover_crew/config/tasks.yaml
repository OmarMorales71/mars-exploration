clean_mission_for_rovers:
  description: >
    You will receive a mission summary in JSON format. Your task is to extract and return
    only the information relevant to surface rover operations. Keep exclusively the
    scientific goals that can be executed by rovers, meaning goals that target surface
    locations identified by node IDs and require ground-based interaction such as sampling,
    measurement, or surface imaging. Remove any goals that are aerial-only, orbital-only or image captured related.
    For each retained goal, include its id, description, target_nodes, terrain, and priority,
    normalizing priority values to exactly one of: high, medium, or low. For constraints,
    always include rover-specific constraints and always include any global constraint that
    applies to all agents (e.g., statements starting with “No agent …”, “All agents …”, or
    “No one …”), because these constraints also restrict rover operations. Also retain only
    hazards relevant to surface navigation or safety, discarding any information related solely
    to drones or satellites.

    Input:
    - mission_summary: {mission_summary}

  expected_output: >
    Return valid JSON only, with no markdown or explanatory text. The output must contain
    exactly three top-level fields: rover_goals, constraints, and hazards. The rover_goals
    field must be an array of scientific goals executable by surface rovers, where each goal
    includes id, description, target_nodes as an array, terrain as a string, and
    priority normalized to one of high, medium, or low. The constraints field must include
    all rover-specific constraints and all global constraints that apply to all agents whenever
    they appear in the mission summary, and the hazards field must list only hazards relevant to
    surface navigation or safety. Do not include any additional fields or wrap arrays as strings.

  agent: rover_context_cleaner

compute_possible_rover_assignments:
  description: >
    You are given a rover mission context in your task context (from clean_mission_for_rovers).
    It contains: rover_goals, constraints, hazards.

    Constrain: 
    The rovers_path_tool must be called just once. 

    Your job: compute rover candidates for every goal by calling rovers_path_tool ONCE.

    Tool call rules (must follow exactly):
    1) Build "goals" by copying ALL items from context.rover_goals into a list of dicts with keys:
       goal_id, description, target_nodes, terrain, priority. (Do not rename keys. Do not change values.)
    2) prohibited_nodes:
       - Extract node ids from hazards strings if present.
         Example hazard: "Node N60: ..." -> prohibited_nodes=["N60"].
       - If you cannot extract any node ids, OMIT prohibited_nodes in the tool call.
    3) energy_threshold:
       - If constraints include "recharge if energy drops below X%", set energy_threshold=X (number).
       - Otherwise OMIT energy_threshold in the tool call or pass 5.0 as default.
    4) energy_cost:
       - Only include energy_cost if the context explicitly gives an energy cost per movement.
       - Otherwise OMIT energy_cost in the tool call or pass 0.2 as default.
    5) Do not pass rover data to the tool (tool already has rovers). Do not pass mars_map (tool already has it).

    After the tool call:
    - Return ONLY valid JSON with one key:
      { "possible_assignments": <tool_output> }
    - Do not add explanations. Do not use markdown.


  expected_output: >
    A single JSON object:
    { "possible_assignments": [...] }
    where the value is exactly the rovers_path_tool output list.

  agent: rover_candidates_analyst

select_rover_candidate:
  description: >
    
    You receive ONE input variable named possible_assignments from input context.
    It is a JSON ARRAY (list) of goal objects. DO NOT CHANGE IT.

    CRITICAL RULE 1 (tool call must pass the list EXACTLY):
    You MUST call split_goals_tool exactly ONCE and you MUST pass the tool parameter
    possible_assignments EXACTLY as shown above, with ZERO changes (no edits, no reformatting,
    no removing fields, no renaming keys, no abbreviations, no summarizing).


    CRITICAL RULE 2 (tool output is NOT the final output):
    The tool output is ONLY used to decide whether a goal_id belongs in assignments or failures.
    The tool output MUST NOT be copied as the final answer.
    All fields in the final output MUST come from the input possible_assignments list.

    CRITICAL RULE 3 (no invention, no modification):
    You MUST ONLY use goals that exist in the input possible_assignments list.
    You MUST NOT invent new goals, descriptions, terrains, target nodes, or candidates.
    You MUST NOT modify goal fields. You MUST copy goal fields EXACTLY as provided in the input list.

    REQUIRED COVERAGE:
    Every goal object in the input possible_assignments list MUST appear exactly once in the output:
    either in assignments OR in failures.
    Therefore:
      len(assignments) + len(failures) == len(possible_assignments)
    and each goal_id appears in exactly one of (assignments, failures), never both.
    
    Take all the information from possible_assignments.
    HOW TO BUILD ASSIGNMENTS:
    For each input goal object where candidates is a non-empty list:
    - Output one assignment object.
    - Copy these fields EXACTLY from the goal object:
      goal_id, description, priority, terrain, target_nodes
    - selected_rover MUST be exactly ONE object copied from that goal's candidates list.
      You are allowed to choose which one, but once chosen you MUST copy it exactly as it appears.
      Do not change rover_id/path/distance/energy_required/recharge_before/speed/location.
    - selection_reason: one short paragraph explaining why you selected that candidate,
      mentioning balancing rover usage if possible + efficiency (energy_required/distance).

    HOW TO BUILD FAILURES:
    For each input goal object where candidates is an empty list:
    - Output one failure object.
    - Copy these fields EXACTLY from the goal object:
      goal_id, description, priority, terrain, target_nodes
    - reason: summarize why it failed using ONLY that goal's no_candidates reasons.

    STRICT OUTPUT QUALITY RULES (to prevent placeholders):
    - description MUST NOT be empty.
    - terrain MUST NOT be empty.
    - target_nodes MUST NOT be empty.
    - For assignments: selected_rover.rover_id must not be empty and selected_rover.path must not be empty.
    If the input has values, you must copy them.

    Output:
    Return ONLY valid JSON matching the output Pydantic model. No markdown, no explanations.

    Important: possible_assignments from input context is the source of truth. Take all the information from possible_assignments.

  expected_output: >
    A JSON object that:
    - uses ONLY the input possible_assignments goals (no extra goals),
    - copies goal fields exactly from possible_assignments,
    - selects exactly one candidate per goal when candidates is non-empty,
    - creates failures only when candidates is empty,
    - and covers all input goals exactly once.

  agent: rover_assignment_selector




